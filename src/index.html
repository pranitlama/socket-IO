<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket + YouTube</title>
  </head>
  <body>
    <div id="player"></div>
    <input id="input-val" placeholder="YouTube Video ID" />
    <button id="send-btn">Send</button>
    <div>
      <button id="prev">Prev</button>
      <button id="next">Next</button>
    </div>
    <div id="messages"></div>
    <!-- Load YouTube Iframe API -->
    <script type="module">
      import { io } from "https://cdn.socket.io/4.8.1/socket.io.esm.min.js";
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      let current = 0;

      const socket = io("http://localhost:3000");

      let musicQueue = [];

      socket.on("connect", () => {
        socket.on("after-connect", (res) => {
          console.log(res);
          musicQueue = res;

          for (let i = 0; i < musicQueue.length; i++) {
            addList(musicQueue[i]);
          }
        });
      });

      const inputVal = document.getElementById("input-val");
      const sendBtn = document.getElementById("send-btn");
      const messages = document.getElementById("messages");
      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");

      function addList(id) {
        const newDiv = document.createElement("div");
        const newImg = document.createElement("img");

        newImg.src = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
        const item = document.createElement("li");
        newDiv.appendChild(newImg);
        newDiv.append(item);
        item.textContent = id;
        messages.appendChild(newDiv);
      }

      sendBtn.addEventListener("click", () => {
        const id = inputVal.value;
        const url = new URL(inputVal.value);
        const ytId = url.searchParams.get("v");
        if (musicQueue.length === 0) {
          player.loadVideoById(ytId);
        }
        if (id) {
          socket.emit("send-data", ytId);
          addList(ytId);
          musicQueue.push(ytId);
        }
        if (current + 1 === musicQueue.indexOf(ytId) + 1) {
          player.loadVideoById(ytId);
        }
        inputVal.value = "";
      });

      socket.on("get-data", (data) => {
        addList(data);
        musicQueue.push(data);
        if (
          current + 1 === musicQueue.indexOf(data) + 1 ||
          musicQueue.length === 0
        ) {
          player.loadVideoById(data);
        }
      });

      // socket.on("send-data", (videoId) => {
      //   if (window.player) {
      //     player.loadVideoById(videoId);
      //   }
      // });
      prevBtn.addEventListener("click", () => {
        if (current !== 0) {
          current--;
          player.loadVideoById(musicQueue[current]);
        }
      });

      nextBtn.addEventListener("click", () => {
        if (current < musicQueue.length) {
          current++;
          player.loadVideoById(musicQueue[current]);
        }
      });

      let player;
      window.onYouTubeIframeAPIReady = function () {
        player = new YT.Player("player", {
          height: "390",
          width: "640",
          videoId: musicQueue[current],
          playerVars: {
            playsinline: 1,
          },
          events: {
            onReady: (event) => {
              event.target.playVideo();
            },
            onStateChange: (event) => {
              if (event.data == YT.PlayerState.ENDED) {
                console.log("Video ended");
                current++;
                console.log(musicQueue[current], musicQueue);
                player.loadVideoById(musicQueue[current]);
              }
            },
          },
        });
      };
    </script>
  </body>
</html>
